<!doctype html>
<html lang="pt-br">
<head>
  <link rel="manifest" href="/static/manifest.json">
  <meta charset="utf-8" />
  <title>BOT CFOP - Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .importada { color: crimson; font-weight: bold; }
    .nacional { color: darkgreen; font-weight: bold; }
    .cfop-card { margin-bottom: 1rem; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4">BOT CFOP (Web)</h2>

    <div class="card p-4 shadow-sm">
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="uf" class="form-label">UF</label>
          <select id="uf" class="form-select"></select>
        </div>
        <div class="col-md-4">
          <label for="proc" class="form-label">Procedência</label>
          <select id="proc" class="form-select">
            <option value="">(qualquer)</option>
            <option value="0">0 - NACIONAL</option>
            <option value="1">1 - IMPORTADA</option>
            <option value="2">2 - IMPORTADA</option>
            <option value="3">3 - IMPORTADA</option>
            <option value="4">4 - NACIONAL</option>
            <option value="5">5 - NACIONAL</option>
            <option value="6">6 - NACIONAL</option>
            <option value="7">7 - NACIONAL</option>
            <option value="8">8 - IMPORTADA</option>
            <option value="90">90 - NACIONAL</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="desc" class="form-label">Descrição</label>
          <input id="desc" type="text" class="form-control" placeholder="Buscar por parte da descrição">
        </div>
      </div>
      <div class="text-end">
        <button id="btnSearch" class="btn btn-primary me-2">Buscar</button>
        <button id="btnClear" class="btn btn-secondary">Limpar</button>
      </div>
    </div>

    <div id="results" class="mt-4"></div>
  </div>

  <script>
    const API_BASE = "/api";
    const ufs = ["AC","AL","AM","AP","BA","CE","DF","ES","GO","MA","MG","MS","MT","PA","PB","PE","PI","PR","RJ","RN","RO","RR","RS","SC","SE","SP","TO"];
    const ufSelect = document.getElementById("uf");
    ufs.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.text = u;
      ufSelect.appendChild(opt);
    });
    ufSelect.value = "SP";

    document.getElementById("btnSearch").addEventListener("click", async () => {
      const uf = ufSelect.value;
      const proc = document.getElementById("proc").value;
      const desc = document.getElementById("desc").value;

      if (!uf) { alert("Selecione UF"); return; }

      const body = { uf: uf, procedencia: proc || "", descricao: desc || "" };
      const res = await fetch(API_BASE + "/filter", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        alert("Erro: " + res.statusText);
        return;
      }
      const items = await res.json();
      renderResults(items);
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      document.getElementById("desc").value = "";
      document.getElementById("proc").value = "";
      document.getElementById("uf").value = "SP";
      document.getElementById("results").innerHTML = "";
    });

    function renderResults(items) {
      const root = document.getElementById("results");
      root.innerHTML = "";
      if (!items || items.length === 0) {
        root.innerHTML = `<div class="alert alert-warning">Nenhuma regra encontrada.</div>`;
        return;
      }

      items.forEach(it => {
        
        const procRaw = (it.procedencia || "").toString().trim();
        const procParts = procRaw.split(/[,;/]/).map(p => p.trim());
        const isImportada = procParts.some(p => ["1","2","3","8"].includes(p));
        const procType = isImportada ? "IMPORTADA" : "NACIONAL";
        const card = document.createElement("div");
        card.className = "card cfop-card shadow-sm";
        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">CFOP: ${it.cfop}</h5>
            <p class="card-text">
              <span class="${procType === 'IMPORTADA' ? 'importada' : 'nacional'}">${procRaw} - ${procType}</span><br>
              ${it.descricao}
            </p>
            <button class="btn btn-outline-primary btn-sm" data-cfop="${it.cfop}">Copiar CFOP</button>
          </div>
        `;
        root.appendChild(card);
      });

      root.querySelectorAll("button[data-cfop]").forEach(btn => {
        btn.addEventListener("click", (ev) => {
          const cf = ev.currentTarget.getAttribute("data-cfop");
          navigator.clipboard.writeText(cf).then(() => {
            alert("CFOP " + cf + " copiado!");
          });
        });
      });
    }
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/static/service-worker.js")
        .then(() => console.log("Service Worker registrado"))
        .catch(err => console.error("Erro ao registrar Service Worker:", err));
    }
  </script>
</body>
</html>